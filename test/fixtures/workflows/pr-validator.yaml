name: validate pull requests
on: pull_request
jobs:
  prettier:
    name: Formatting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repo
        uses: actions/checkout@2541b1294d2704b0964813337f33b291d3f8596b # v3.0.2
      - name: Run Shellcheck
        uses: ludeeus/action-shellcheck@94e0aab03ca135d11a35e5bfc14e6746dc56e7e9 # pin@master
      - name: Run Prettier
        uses: creyD/prettier_action@394fa2de3b2acce9f63808b958c54aa823a43b71 # pin@v3.1
        with:
          dry: true
          prettier_options: --write **/*.{yaml,yml,json}
  helmlint:
    name: Helm
    runs-on: ubuntu-latest
    env:
      CT_TARGET_BRANCH: ${{ github.event.pull_request.base.ref }}
    steps:
      - name: Checkout
        uses: actions/checkout@2541b1294d2704b0964813337f33b291d3f8596b # v3.0.2
        with:
          fetch-depth: "0"
      - name: Set up chart-testing
        uses: helm/chart-testing-action@b0d4458c71155b54fcf33e11dd465dc923550009 # pin@v2.0.1
      - name: Run chart-testing (list-changed)
        id: list-changed
        run: |
          changed=$(ct list-changed --config .ct.yaml)
          if [[ -n "$changed" ]]; then
            echo "::set-output name=changed::true"
          fi
      - name: Run chart-testing (lint)
        run: ct lint --config .ct.yaml --excluded-charts
          astronomer-wrapper,cluster-bootstrap,cluster-calico,homu # Excluding these since ct fails to lint/install them.
  sops:
    name: Checking unencrypted secrets
    runs-on: ubuntu-latest
    steps:
      - name: Check
        uses: AndresJulia/sops-gh@1f2fc77c307fac41f211e641583dbaac44a05497 # pin@v1
        with:
          filename_pattern: secrets
